# SuperPicky V4.0 开发计划

**版本**: 4.0.0  
**计划日期**: 2026-01-13  
**预计开发周期**: 3-5 天  
**当前版本**: 3.9.4

---

## 📋 目标概览

### 主要任务
1. **🦜 鸟类识别集成** (Major Feature)
   - 集成现有的鸟类物种识别模型
   - 在评分流程中添加物种识别步骤
   - 在 EXIF 元数据中写入物种信息
   - UI 显示物种识别结果

2. **🐛 RAW+JPEG 保留修复** (Bug Fix)
   - 修复用户已拍摄 RAW+JPEG 时，JPEG 被错误删除的问题
   - 保留用户原始 JPEG 文件，仅删除临时转换的 JPEG

---

## 🔍 技术分析

### 任务 1: 鸟类识别集成

#### 当前状态
- ✅ **已有模型**: 项目中已有 YOLO 模型 (`yolo11l-seg.pt`, `yolo11m-seg.pt`)
- ✅ **检测流程**: `ai_model.py` 中的 `detect_and_draw_birds()` 已实现鸟类检测
- ❌ **缺失功能**: 无物种识别（species classification）功能

#### 需要的模型
用户提到"模型是现成的"，需要确认：
- 模型文件位置和格式（.pt / .onnx / .h5）
- 模型输入输出格式
- 支持的物种列表
- 推理性能（速度）

#### 集成点分析

**核心文件**: `core/photo_processor.py`

**集成位置**: `_process_images()` 方法
- **当前流程**:
  1. YOLO 鸟类检测 (line 351-362)
  2. 关键点检测 (line 403-515)
  3. TOPIQ 美学评分 (line 517-538)
  4. 飞版检测 (line 540-551)
  5. 曝光检测 (line 553-566)
  6. 对焦验证 (line 593-677)
  7. 评分计算 (line 679-697)
  8. EXIF 写入 (line 784-862)

- **建议插入点**: 在 YOLO 检测之后，关键点检测之前
  - 原因: 物种识别需要鸟的裁剪区域 (`bird_crop_bgr`)
  - 位置: line 402 附近

**数据流**:
```
YOLO检测 → 获取bird_crop_bgr → 物种识别 → 继续后续流程
```

#### 实现方案

**新增文件**: `core/species_classifier.py`

```python
class SpeciesClassifier:
    def __init__(self, model_path: str):
        # 加载模型
        
    def classify(self, bird_crop: np.ndarray) -> SpeciesResult:
        # 返回: species_name, confidence, chinese_name
```

**修改文件**:
1. `core/photo_processor.py`
   - 在 `_process_images()` 中添加物种识别调用
   - 在 EXIF 写入中添加物种字段
   
2. `ui/main_window.py`
   - 在结果显示中添加物种信息列

3. `superpicky_cli.py`
   - CLI 输出中显示物种信息

**EXIF 字段映射**:
- `Subject`: 物种中文名
- `Keywords`: 物种英文名 + 学名
- `Caption`: 在现有说明中添加物种信息

---

### 任务 2: RAW+JPEG 保留修复

#### Bug 分析

**问题代码**: `core/photo_processor.py` line 1264-1282

```python
def _cleanup_temp_files(self, files_tbr, raw_dict):
    """清理临时JPG文件"""
    self._log("\n🧹 清理临时文件...")
    deleted_count = 0
    for filename in files_tbr:
        file_prefix, file_ext = os.path.splitext(filename)
        if file_prefix in raw_dict and file_ext.lower() in ['.jpg', '.jpeg']:
            jpg_path = os.path.join(self.dir_path, filename)
            try:
                if os.path.exists(jpg_path):
                    os.remove(jpg_path)  # ❌ 问题：删除所有 JPEG
                    deleted_count += 1
```

**问题根源**:
- 当前逻辑: 如果存在同名 RAW，就删除 JPEG
- 错误场景: 用户相机同时拍摄 RAW+JPEG，JPEG 是原始文件而非临时转换

**临时 JPEG 识别**:
当前有两种 JPEG 来源：
1. **用户原始 JPEG**: 相机拍摄的 RAW+JPEG
2. **临时转换 JPEG**: `raw_to_jpeg()` 从 RAW 转换的

**区分方法**:
- 临时转换的 JPEG 在 `_convert_raws()` 中创建 (line 244-283)
- 需要标记哪些 JPEG 是临时转换的

#### 解决方案

**方案 A: 时间戳判断** (推荐)
- 比较 JPEG 和 RAW 的创建时间
- 如果 JPEG 创建时间 ≈ RAW 创建时间（±5秒），认为是用户原始文件
- 如果 JPEG 创建时间 > RAW 修改时间，认为是临时转换

**方案 B: 标记集合**
- 在 `_convert_raws()` 中记录临时转换的文件名到集合
- 在 `_cleanup_temp_files()` 中只删除集合中的文件

**方案 C: 文件名前缀**
- 临时转换的 JPEG 使用特殊前缀（如 `_tmp_`）
- 清理时只删除带前缀的文件
- ⚠️ 需要修改 `raw_to_jpeg()` 函数

**推荐**: **方案 B**（最可靠）
- 优点: 精确、无歧义
- 缺点: 需要传递额外参数

#### 实现方案

**修改 1**: `PhotoProcessor.__init__()`
```python
def __init__(self, ...):
    # 新增: 记录临时转换的 JPEG
    self.temp_converted_jpegs = set()
```

**修改 2**: `PhotoProcessor._convert_raws()`
```python
def _convert_raws(self, raw_files_to_convert, files_tbr):
    # ...
    for future in as_completed(future_to_raw):
        key, success, error = future.result()
        if success:
            jpeg_filename = key + ".jpg"
            files_tbr.append(jpeg_filename)
            self.temp_converted_jpegs.add(jpeg_filename)  # ✅ 标记
```

**修改 3**: `PhotoProcessor._cleanup_temp_files()`
```python
def _cleanup_temp_files(self, files_tbr, raw_dict):
    """清理临时JPG文件"""
    self._log("\n🧹 清理临时文件...")
    deleted_count = 0
    for filename in files_tbr:
        file_prefix, file_ext = os.path.splitext(filename)
        # ✅ 只删除临时转换的 JPEG
        if (file_prefix in raw_dict and 
            file_ext.lower() in ['.jpg', '.jpeg'] and
            filename in self.temp_converted_jpegs):
            jpg_path = os.path.join(self.dir_path, filename)
            try:
                if os.path.exists(jpg_path):
                    os.remove(jpg_path)
                    deleted_count += 1
```

---

## 📅 开发计划

### Day 1: 准备与设计
- [ ] 确认鸟类识别模型细节（模型文件、输入输出格式）
- [ ] 设计物种识别 API 接口
- [ ] 创建 `core/species_classifier.py` 骨架
- [ ] 编写单元测试框架

### Day 2: 物种识别集成
- [ ] 实现 `SpeciesClassifier` 类
- [ ] 集成到 `photo_processor.py`
- [ ] 添加 EXIF 元数据写入
- [ ] 单元测试

### Day 3: UI 和 CLI 更新
- [ ] 更新 GUI 结果显示（添加物种列）
- [ ] 更新 CLI 输出格式
- [ ] 更新日志格式
- [ ] 集成测试

### Day 4: Bug 修复
- [ ] 实现 RAW+JPEG 保留逻辑
- [ ] 测试各种场景:
  - 纯 RAW
  - 纯 JPEG
  - RAW+JPEG（用户原始）
  - RAW（需转换）
- [ ] 回归测试

### Day 5: 测试与发布
- [ ] 完整功能测试
- [ ] 性能测试（物种识别对速度的影响）
- [ ] 更新文档
- [ ] 准备 Release Notes
- [ ] 打包和签名

---

## 🧪 测试策略

### 功能测试

#### 物种识别测试
- [ ] 单一物种照片
- [ ] 多物种照片（取置信度最高）
- [ ] 无鸟照片（跳过识别）
- [ ] 低质量照片（识别失败处理）

#### JPEG 保留测试
| 场景 | RAW | JPEG | 预期行为 |
|------|-----|------|----------|
| 1 | ✅ | ❌ | 转换 RAW → 临时 JPEG → 处理后删除 |
| 2 | ❌ | ✅ | 直接处理 JPEG → 不删除 |
| 3 | ✅ | ✅ (原始) | 处理 JPEG → **保留** |
| 4 | ✅ | ✅ (转换) | 转换 RAW → 临时 JPEG → 处理后删除 |

### 性能测试
- [ ] 100 张照片处理时间对比（v3.9.4 vs v4.0）
- [ ] 物种识别单张耗时
- [ ] 内存占用

### 兼容性测试
- [ ] macOS (Apple Silicon)
- [ ] macOS (Intel) - 如果支持
- [ ] Windows - 如果支持

---

## 📊 预期影响

### 性能影响
- **物种识别**: 预计每张照片增加 50-200ms
- **总体影响**: 对于 100 张照片，增加 5-20 秒
- **优化**: 可考虑并行处理或缓存

### 用户体验
- ✅ **新功能**: 自动识别鸟类物种
- ✅ **Bug 修复**: 不再误删用户 JPEG
- ✅ **元数据**: Lightroom 中可查看物种信息

### 代码质量
- **新增代码**: ~300 行
- **修改代码**: ~50 行
- **测试代码**: ~200 行

---

## ⚠️ 风险与缓解

### 风险 1: 物种识别模型性能
- **风险**: 模型推理速度慢，影响整体处理时间
- **缓解**: 
  - 添加开关，允许用户禁用物种识别
  - 使用 GPU 加速（MPS）
  - 批量推理优化

### 风险 2: 物种识别准确性
- **风险**: 识别错误导致错误标注
- **缓解**:
  - 显示置信度，低于阈值不写入
  - 允许用户手动修正
  - 提供"未识别"选项

### 风险 3: JPEG 保留逻辑复杂性
- **风险**: 边缘情况导致误删或误留
- **缓解**:
  - 充分测试各种场景
  - 添加详细日志
  - 提供"安全模式"（不删除任何文件）

---

## 📝 待确认问题

### 物种识别模型
1. 模型文件路径和名称？
2. 模型格式（PyTorch / ONNX / TensorFlow）？
3. 输入尺寸要求？
4. 支持的物种数量和列表？
5. 是否需要预处理（归一化等）？
6. 推理设备（CPU / MPS / CUDA）？

### UI/UX 设计
1. 物种信息在 GUI 中的显示位置？
2. 是否需要物种筛选功能？
3. 是否需要物种统计（如"共识别到 5 种鸟"）？

### 配置选项
1. 是否添加"启用物种识别"开关？
2. 物种识别置信度阈值（默认值）？
3. 是否添加"保留所有 JPEG"选项？

---

## 📚 相关文件清单

### 需要修改的文件
- `core/photo_processor.py` - 主处理流程
- `ui/main_window.py` - GUI 结果显示
- `superpicky_cli.py` - CLI 输出
- `exiftool_manager.py` - EXIF 元数据写入

### 需要新建的文件
- `core/species_classifier.py` - 物种识别器
- `tests/test_species_classifier.py` - 单元测试
- `tests/test_jpeg_preservation.py` - JPEG 保留测试

### 需要更新的文档
- `README.md` - 功能说明
- `release_notes_v4.0.0.md` - 发布说明
- `docs/index.html` - 网站文档

---

## 🎯 成功标准

### 物种识别
- ✅ 能够正确识别至少 80% 的常见鸟类
- ✅ 识别失败时不影响评分流程
- ✅ 物种信息正确写入 EXIF
- ✅ GUI 和 CLI 正确显示物种

### JPEG 保留
- ✅ 用户原始 JPEG 100% 保留
- ✅ 临时转换 JPEG 100% 删除
- ✅ 无误删、无误留

### 性能
- ✅ 处理时间增加 < 30%
- ✅ 内存占用增加 < 20%

### 质量
- ✅ 所有单元测试通过
- ✅ 所有集成测试通过
- ✅ 无回归 bug

---

## 📞 下一步行动

1. **立即**: 确认物种识别模型细节
2. **Day 1**: 开始设计和准备工作
3. **每日**: 更新此文档的进度
4. **完成后**: 创建 Release Notes

---

**文档版本**: 1.0  
**最后更新**: 2026-01-13
