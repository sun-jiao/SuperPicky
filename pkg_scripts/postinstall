#!/bin/bash
# SuperPicky V4.0.3 - å®‰è£…åé…ç½®è„šæœ¬
# Post-install configuration script

echo "Configuring SuperPicky V4.0.3..."

APP_PATH="/Applications/SuperPicky.app"

# è·å–çœŸå®ç”¨æˆ·ï¼ˆè€Œé rootï¼‰
# Get real user (not root)
REAL_USER=$(stat -f '%Su' /dev/console)
REAL_HOME=$(eval echo ~$REAL_USER)

echo "User: $REAL_USER"
echo "Home: $REAL_HOME"

# ============================================
# Language Detection / è¯­è¨€æ£€æµ‹
# ============================================
IS_CHINESE=0
# Check global preferences for Simplified Chinese
if defaults read -g AppleLanguages 2>/dev/null | grep -q "zh-Hans"; then
    IS_CHINESE=1
fi

# Define Strings based on language
if [ "$IS_CHINESE" -eq 1 ]; then
    TXT_TITLE="æ…§çœ¼é€‰é¸Ÿ - Lightroom æ’ä»¶å®‰è£…"
    TXT_PROMPT="è¯·é€‰æ‹©è¦å®‰è£…æ’ä»¶çš„ Lightroom ç‰ˆæœ¬ï¼š"
    TXT_NOTE="(å¯æŒ‰ä½ Command é”®å¤šé€‰)"
    TXT_OPT_USER="Lightroom ç”¨æˆ·æ¨¡å— (æ¨è)"
    TXT_OPT_CLASSIC="Lightroom Classic åº”ç”¨å†… (éœ€é‡å¯LR)"
    TXT_OPT_APP_IN="åº”ç”¨å†…"
    TXT_MSG_NO_LR="âš  æœªæ£€æµ‹åˆ° Lightroom å®‰è£…"
    TXT_MSG_MANUAL="æ’ä»¶å·²ä¿å­˜åœ¨åº”ç”¨åŒ…å†…ï¼Œæ‚¨å¯ä»¥ç¨åæ‰‹åŠ¨å®‰è£…"
    TXT_MSG_CANCEL="ç”¨æˆ·å–æ¶ˆäº†æ’ä»¶å®‰è£…"
    TXT_MSG_MANUAL_HINT="æ‚¨å¯ä»¥ç¨åä»åº”ç”¨åŒ…å†…æ‰‹åŠ¨å¤åˆ¶æ’ä»¶"
    TXT_MSG_SUCCESS="âœ“ Lightroom æ’ä»¶å®‰è£…å®Œæˆ"
else
    TXT_TITLE="SuperPicky - Lightroom Plugin Installer"
    TXT_PROMPT="Please select Lightroom versions to install the plugin:"
    TXT_NOTE="(Hold Command key to select multiple)"
    TXT_OPT_USER="Lightroom User Modules (Recommended)"
    TXT_OPT_CLASSIC="Lightroom Classic Internal (Requires Restart)"
    TXT_OPT_APP_IN="Inside App"
    TXT_MSG_NO_LR="âš  No Lightroom installation detected"
    TXT_MSG_MANUAL="Plugin is inside the app bundle, you can install manually later"
    TXT_MSG_CANCEL="User cancelled plugin installation"
    TXT_MSG_MANUAL_HINT="You can manually copy the plugin from the app bundle later"
    TXT_MSG_SUCCESS="âœ“ Lightroom Plugin installation completed"
fi

# 1. è®¾ç½®åº”ç”¨æƒé™ / Set permissions
chmod -R 755 "$APP_PATH"
echo "âœ“ Application permissions set"

# 2. è®¾ç½® ExifTool å¯æ‰§è¡Œæƒé™ / Set ExifTool permissions
EXIFTOOL_PATH="$APP_PATH/Contents/Frameworks/exiftools_mac/exiftool"
if [ -f "$EXIFTOOL_PATH" ]; then
    chmod +x "$EXIFTOOL_PATH"
    echo "âœ“ ExifTool permissions set"
fi

# 3. è®¾ç½® ExifTool lib ç›®å½•æƒé™
LIB_DIR="$APP_PATH/Contents/Frameworks/exiftools_mac/lib"
if [ -d "$LIB_DIR" ]; then
    chmod -R 755 "$LIB_DIR"
fi

# 4. å®‰è£… Lightroom æ’ä»¶ / Install Lightroom Plugin
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Detecting Lightroom versions..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

PLUGIN_SOURCE="$APP_PATH/Contents/Resources/SuperBirdIDPlugin.lrplugin"

# æ£€æµ‹å¯ç”¨çš„ Lightroom ç‰ˆæœ¬
declare -a LR_OPTIONS
declare -a LR_PATHS
declare -a LR_NAMES

# ç”¨æˆ· Modules ç›®å½•ï¼ˆæ¨èï¼‰
USER_MODULES="$REAL_HOME/Library/Application Support/Adobe/Lightroom/Modules"
if [ -d "$REAL_HOME/Library/Application Support/Adobe/Lightroom" ]; then
    LR_OPTIONS+=("$TXT_OPT_USER")
    LR_PATHS+=("$USER_MODULES")
    LR_NAMES+=("Lightroom User Modules")
    echo "  âœ“ Found: Lightroom User Directory"
fi

# Lightroom Classic åº”ç”¨å†… PlugInsï¼ˆéœ€è¦ adminï¼‰
LR_CLASSIC_PLUGINS="/Applications/Adobe Lightroom Classic/Adobe Lightroom Classic.app/Contents/PlugIns"
if [ -d "$LR_CLASSIC_PLUGINS" ]; then
    LR_OPTIONS+=("$TXT_OPT_CLASSIC")
    LR_PATHS+=("$LR_CLASSIC_PLUGINS")
    LR_NAMES+=("Lightroom Classic App")
    echo "  âœ“ Found: Lightroom Classic App"
fi

# æ£€æµ‹å…¶ä»–å¯èƒ½çš„ Lightroom å®‰è£…
for lr_app in /Applications/Adobe\ Lightroom*/Adobe\ Lightroom*.app/Contents/PlugIns; do
    if [ -d "$lr_app" ] && [[ "$lr_app" != "$LR_CLASSIC_PLUGINS" ]]; then
        app_name=$(basename "$(dirname "$(dirname "$lr_app")")" | sed 's/Adobe //')
        LR_OPTIONS+=("$app_name $TXT_OPT_APP_IN")
        LR_PATHS+=("$lr_app")
        LR_NAMES+=("$app_name")
        echo "  âœ“ Found: $app_name"
    fi
done

# å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½• Lightroom
if [ ${#LR_OPTIONS[@]} -eq 0 ]; then
    echo "$TXT_MSG_NO_LR"
    echo "$TXT_MSG_MANUAL"
    echo "Path: $PLUGIN_SOURCE"
else
    echo ""
    echo "Found ${#LR_OPTIONS[@]} install locations"
    
    # æ„å»º osascript é€‰é¡¹åˆ—è¡¨
    OPTIONS_STR=""
    for opt in "${LR_OPTIONS[@]}"; do
        if [ -z "$OPTIONS_STR" ]; then
            OPTIONS_STR="\"$opt\""
        else
            OPTIONS_STR="$OPTIONS_STR, \"$opt\""
        fi
    done
    
    # ä½¿ç”¨ osascript å¼¹å‡ºå¤šé€‰å¯¹è¯æ¡†
    # Using osascript to show dialog
    echo "Showing selection dialog..."
    
    # Passing variables to osascript is tricky with heredoc variables inside heredoc
    # We construct the Applescript string with our bash variables
    
    SELECTED=$(osascript -e "
        set theChoices to {$OPTIONS_STR}
        set selectedItems to choose from list theChoices with title \"$TXT_TITLE\" with prompt \"$TXT_PROMPT
        
$TXT_NOTE\" default items {item 1 of theChoices} with multiple selections allowed
        if selectedItems is false then
            return \"CANCELLED\"
        else
            set AppleScript's text item delimiters to \"|||\"
            return selectedItems as text
        end if
    " 2>/dev/null)
    
    if [ "$SELECTED" = "CANCELLED" ] || [ -z "$SELECTED" ]; then
        echo "$TXT_MSG_CANCEL"
        echo "$TXT_MSG_MANUAL_HINT"
    else
        echo "User selection: $SELECTED"
        echo ""
        
        INSTALLED_COUNT=0
        
        # è§£æç”¨æˆ·é€‰æ‹©å¹¶å®‰è£…
        IFS='|||' read -ra SELECTED_ITEMS <<< "$SELECTED"
        for selection in "${SELECTED_ITEMS[@]}"; do
            # æŸ¥æ‰¾å¯¹åº”çš„è·¯å¾„
            for i in "${!LR_OPTIONS[@]}"; do
                if [ "${LR_OPTIONS[$i]}" = "$selection" ]; then
                    TARGET_PATH="${LR_PATHS[$i]}"
                    TARGET_NAME="${LR_NAMES[$i]}"
                    
                    echo "Installing to: $TARGET_NAME..."
                    
                    # åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                    mkdir -p "$TARGET_PATH"
                    
                    # åˆ é™¤æ—§ç‰ˆæœ¬
                    if [ -d "$TARGET_PATH/SuperBirdIDPlugin.lrplugin" ]; then
                        rm -rf "$TARGET_PATH/SuperBirdIDPlugin.lrplugin"
                    fi
                    
                    # å¤åˆ¶æ’ä»¶
                    if cp -R "$PLUGIN_SOURCE" "$TARGET_PATH/"; then
                        # è®¾ç½®æ­£ç¡®çš„æ‰€æœ‰è€…ï¼ˆç”¨æˆ·ç›®å½•éœ€è¦ï¼‰
                        if [[ "$TARGET_PATH" == "$REAL_HOME"* ]]; then
                            chown -R "$REAL_USER" "$TARGET_PATH/SuperBirdIDPlugin.lrplugin"
                        fi
                        echo "  âœ“ Installed to: $TARGET_NAME"
                        INSTALLED_COUNT=$((INSTALLED_COUNT + 1))
                    else
                        echo "  âœ— Failed to install: $TARGET_NAME"
                    fi
                    break
                fi
            done
        done
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "$TXT_MSG_SUCCESS ($INSTALLED_COUNT locations)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    fi
fi

# 6. å®‰è£… Lightroom å¯¼å‡ºé¢„è®¾ / Install Export Presets
echo ""
echo "Installing Lightroom Export Presets..."
PRESET_SOURCE="$APP_PATH/Contents/Resources/SuperBirdIDPlugin.lrplugin/SuperPicky.lrtemplate"
PRESET_DIR="$REAL_HOME/Library/Application Support/Adobe/Lightroom/Export Presets/User Presets"

if [ -f "$PRESET_SOURCE" ]; then
    mkdir -p "$PRESET_DIR"
    cp "$PRESET_SOURCE" "$PRESET_DIR/"
    chown "$REAL_USER" "$PRESET_DIR/SuperPicky.lrtemplate"
    echo "âœ“ Export preset installed to: $PRESET_DIR"
else
    echo "âš  Export preset file not found, skipping"
fi

# 7. æ¸…é™¤éš”ç¦»æ ‡è®° / Clear quarantine
xattr -cr "$APP_PATH" 2>/dev/null || true
echo "âœ“ Quarantine cleared"

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… SuperPicky V4.0.3 Installation Completed!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“ Location: /Applications/SuperPicky.app"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ "$IS_CHINESE" -eq 1 ]; then
    echo "âš ï¸  Lightroom æ’ä»¶é¦–æ¬¡ä½¿ç”¨è¯´æ˜ï¼š"
    echo ""
    echo "   1. æ‰“å¼€ Lightroom â†’ æ–‡ä»¶ â†’ å¢æ•ˆå·¥å…·ç®¡ç†å™¨"
    echo "   2. åœ¨å·¦ä¾§åˆ—è¡¨æ‰¾åˆ° SuperPicky BirdID Plugin"
    echo "   3. ç‚¹å‡»å³ä¾§ã€Œå¯ç”¨ã€æŒ‰é’®"
else
    echo "âš ï¸  Lightroom Plugin First-time Setup:"
    echo ""
    echo "   1. Open Lightroom â†’ File â†’ Plug-in Manager"
    echo "   2. Find 'SuperPicky BirdID Plugin' in the list"
    echo "   3. Click the 'Enable' button on the right"
fi
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

exit 0
